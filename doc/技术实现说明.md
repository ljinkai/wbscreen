# 网页截图服务技术实现说明

## 1. 项目概述

本项目旨在实现一个基于 Node.js 的服务端网页截图功能，通过 RESTful API 提供网页截图服务。用户可以通过 API 请求指定 URL，服务端将自动访问该网页并返回截图。

## 2. 技术选型

### 2.1 核心技术栈
- **Node.js**: 服务端运行环境
- **Express**: Web 框架，用于构建 RESTful API
- **Puppeteer**: 无头浏览器控制库，用于网页渲染和截图

### 2.2 技术选型理由
- **Puppeteer** 是 Google Chrome 团队维护的 Node.js 库，基于 Chromium，能够完美渲染现代网页
- 支持 JavaScript 执行，可以处理动态内容
- 提供丰富的截图选项（全屏、视口、元素等）
- 性能稳定，社区活跃

### 2.3 备选方案
- **Playwright**: 支持多浏览器（Chromium、Firefox、WebKit），功能更强大但体积更大
- **Selenium**: 传统方案，配置复杂，性能相对较低

## 3. 系统架构设计

### 3.1 架构图
```
┌─────────────┐
│  客户端请求  │
└──────┬──────┘
       │ HTTP/HTTPS
       ▼
┌─────────────────────┐
│   Express 服务器     │
│  ┌───────────────┐  │
│  │  API 路由层   │  │
│  └───────┬───────┘  │
│          │          │
│  ┌───────▼───────┐  │
│  │  业务逻辑层   │  │
│  │ - 参数验证    │  │
│  │ - 请求处理    │  │
│  └───────┬───────┘  │
└──────────┼──────────┘
           │
           ▼
┌─────────────────────┐
│   Puppeteer 引擎     │
│  ┌───────────────┐  │
│  │  Chromium     │  │
│  │  浏览器实例    │  │
│  └───────────────┘  │
└─────────────────────┘
```

### 3.2 核心模块
1. **API 路由模块**: 处理 HTTP 请求
2. **截图服务模块**: 封装 Puppeteer 截图逻辑
3. **参数验证模块**: 验证和规范化输入参数
4. **错误处理模块**: 统一错误处理和响应
5. **七牛云上传模块**: 自动上传截图到七牛云存储

## 4. API 设计

### 4.1 截图接口

#### 请求
- **URL**: `POST /api/screenshot`
- **Content-Type**: `application/json`

#### 请求参数
```json
{
  "url": "https://example.com",        // 必填：目标网页 URL
  "width": 1920,                       // 可选：视口宽度（默认 1920）
  "height": 1080,                      // 可选：视口高度（默认 1080）
  "fullPage": false,                    // 可选：是否截取整页（默认 false）
  "format": "png",                     // 可选：图片格式 png/jpeg（默认 png）
  "quality": 90,                       // 可选：JPEG 质量 0-100（仅 JPEG 有效）
  "waitUntil": "networkidle0",         // 可选：等待条件（默认 networkidle0）
  "timeout": 30000,                    // 可选：超时时间（毫秒，默认 30000）
  "returnBase64": false,               // 可选：是否返回 base64 编码（默认 false）
  "returnBinary": false,               // 可选：是否返回二进制图片（默认 false，返回 JSON）
  "viewport": {                        // 可选：视口配置
    "width": 1920,
    "height": 1080,
    "deviceScaleFactor": 1
  },
  "options": {                         // 可选：Puppeteer 高级选项
    "clip": {                          // 裁剪区域
      "x": 0,
      "y": 0,
      "width": 1920,
      "height": 1080
    }
  }
}
```

#### 响应
**成功响应** (200 OK)

**默认模式**（配置了七牛云，`returnBinary: false`）：
- **Content-Type**: `application/json`
- **Body**: JSON 格式，包含七牛云访问 URL
```json
{
  "success": true,
  "format": "png",
  "url": "https://cdn.example.com/screenshots/1234567890_abc123.png",
  "key": "screenshots/1234567890_abc123.png",
  "hash": "Fh8xVqod2QW1PY..."
}
```

**二进制模式**（`returnBinary: true`）：
- **Content-Type**: `image/png` 或 `image/jpeg`
- **Body**: 图片二进制数据

**Base64 模式**（`returnBase64: true`）：
- **Content-Type**: `application/json`
- **Body**: JSON 格式
```json
{
  "success": true,
  "format": "png",
  "base64": "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAA..."
}
```

**七牛云上传模式**（配置了七牛云且 `QINIU_AUTO_UPLOAD=true`，默认行为）：
- **Content-Type**: `application/json`
- **Body**: JSON 格式
```json
{
  "success": true,
  "format": "png",
  "url": "https://cdn.example.com/screenshots/1234567890_abc123.png",
  "key": "screenshots/1234567890_abc123.png",
  "hash": "Fh8xVqod2QW1PY..."
}
```

**错误响应** (400/500)
```json
{
  "error": true,
  "message": "错误描述",
  "code": "ERROR_CODE"
}
```

### 4.2 健康检查接口

#### 请求
- **URL**: `GET /api/health`
- **Method**: GET

#### 响应
```json
{
  "status": "ok",
  "timestamp": "2024-01-01T00:00:00.000Z"
}
```

## 5. 实现步骤

### 5.1 项目初始化
```bash
# 初始化 Node.js 项目
npm init -y

# 安装核心依赖
npm install express puppeteer

# 安装开发依赖
npm install --save-dev nodemon
```

### 5.2 目录结构
```
wbscreen/
├── src/
│   ├── index.js              # 入口文件
│   ├── routes/
│   │   └── screenshot.js     # 截图路由
│   ├── services/
│   │   └── screenshotService.js  # 截图服务
│   ├── utils/
│   │   ├── validator.js      # 参数验证
│   │   └── errorHandler.js   # 错误处理
│   └── config/
│       └── default.js        # 默认配置
├── doc/
│   └── 技术实现说明.md
├── package.json
└── README.md
```

### 5.3 核心实现要点

#### 5.3.1 浏览器实例管理
- 使用单例模式管理 Puppeteer 浏览器实例
- 实现浏览器池以提高并发性能
- 定期清理不活跃的页面实例

#### 5.3.2 截图服务实现
```javascript
// 伪代码示例
async function takeScreenshot(url, options) {
  const browser = await getBrowserInstance();
  const page = await browser.newPage();
  
  try {
    // 设置视口
    await page.setViewport(options.viewport);
    
    // 访问页面
    await page.goto(url, {
      waitUntil: options.waitUntil,
      timeout: options.timeout
    });
    
    // 执行截图
    const screenshot = await page.screenshot({
      type: options.format,
      quality: options.quality,
      fullPage: options.fullPage
    });
    
    return screenshot;
  } finally {
    await page.close();
  }
}
```

#### 5.3.3 错误处理
- URL 验证（格式、协议检查）
- 超时处理
- 网络错误处理
- 浏览器崩溃恢复

#### 5.3.4 性能优化
- 浏览器实例复用
- 请求队列管理（避免资源耗尽）
- 缓存机制（相同 URL 的截图）
- 并发控制（限制同时处理的请求数）

## 6. 依赖项说明

### 6.1 生产依赖
- **express** (^4.18.0): Web 框架
- **puppeteer** (^24.15.0): 无头浏览器控制库
- **qiniu** (^7.8.0): 七牛云存储 SDK

### 6.2 开发依赖
- **nodemon** (^3.0.0): 开发时自动重启

### 6.3 系统要求
- Node.js >= 16.0.0
- 足够的系统内存（建议 2GB+）
- 网络连接（用于访问目标网页）

## 7. 配置说明

### 7.1 环境变量
```bash
# 服务端口
PORT=3000

# 浏览器配置
PUPPETEER_HEADLESS=true
PUPPETEER_ARGS=--no-sandbox,--disable-setuid-sandbox

# 性能配置
MAX_CONCURRENT_REQUESTS=5
BROWSER_POOL_SIZE=3
REQUEST_TIMEOUT=30000

# 七牛云配置（可选，配置后自动上传截图到七牛云）
QINIU_ACCESS_KEY=your_access_key
QINIU_SECRET_KEY=your_secret_key
QINIU_BUCKET=static
QINIU_DOMAIN=https://cdn.example.com
QINIU_ZONE=Zone_z0
QINIU_AUTO_UPLOAD=true
```

### 7.2 默认配置
- 视口大小: 1920x1080
- 截图格式: PNG
- 等待策略: networkidle0（网络空闲）
- 超时时间: 30秒

## 8. 安全考虑

### 8.1 URL 白名单（可选）
- 限制可访问的域名
- 防止 SSRF 攻击

### 8.2 请求限制
- 频率限制（Rate Limiting）
- 请求大小限制
- 超时限制

### 8.3 资源限制
- 内存使用限制
- CPU 使用限制
- 并发请求数限制

## 9. 使用示例

### 9.1 基本使用
```bash
curl -X POST http://localhost:3000/api/screenshot \
  -H "Content-Type: application/json" \
  -d '{
    "url": "https://example.com"
  }' \
  --output screenshot.png
```

### 9.2 截取整页
```bash
curl -X POST http://localhost:3000/api/screenshot \
  -H "Content-Type: application/json" \
  -d '{
    "url": "https://example.com",
    "fullPage": true
  }' \
  --output fullpage.png
```

### 9.3 自定义视口
```bash
curl -X POST http://localhost:3000/api/screenshot \
  -H "Content-Type: application/json" \
  -d '{
    "url": "https://example.com",
    "width": 375,
    "height": 667
  }' \
  --output mobile.png
```

### 9.4 返回 Base64 编码
```bash
curl -X POST http://localhost:3000/api/screenshot \
  -H "Content-Type: application/json" \
  -d '{
    "url": "https://example.com",
    "returnBase64": true
  }'
```

响应示例：
```json
{
  "success": true,
  "format": "png",
  "base64": "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAA..."
}
```

## 10. 部署建议

### 10.1 Docker 部署
- 使用官方 Node.js 镜像
- 安装 Chromium 依赖
- 配置资源限制

### 10.2 进程管理
- 使用 PM2 进行进程管理
- 配置自动重启
- 监控日志

### 10.3 反向代理
- 使用 Nginx 作为反向代理
- 配置负载均衡
- SSL/TLS 终止

## 11. 监控和日志

### 11.1 日志记录
- 请求日志（URL、参数、响应时间）
- 错误日志（详细错误信息）
- 性能日志（内存、CPU 使用）

### 11.2 监控指标
- 请求数量
- 成功率
- 平均响应时间
- 浏览器实例使用率

## 12. 扩展功能（可选）

### 12.1 功能扩展
- PDF 生成
- 多页面批量截图
- 截图对比
- 水印添加
- 图片压缩

### 12.2 存储选项
- 本地文件存储
- 对象存储（OSS/S3）
- 数据库存储（元数据）

## 13. 注意事项

1. **内存管理**: Puppeteer 会消耗大量内存，需要合理配置浏览器实例数量
2. **网络环境**: 确保服务器能够访问目标网页
3. **反爬虫机制**: 某些网站可能有反爬虫机制，需要适当处理
4. **资源清理**: 及时关闭页面和浏览器实例，避免内存泄漏
5. **并发控制**: 限制并发请求数，避免系统资源耗尽

## 14. 参考资料

- [Puppeteer 官方文档](https://pptr.dev/)
- [Express 官方文档](https://expressjs.com/)
- [Node.js 官方文档](https://nodejs.org/)

